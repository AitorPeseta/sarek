/*
========================================================================================
    Config file for defining DSL2 per module options and publishing paths
========================================================================================
    Available keys to override module options:
        ext.args            = Additional arguments appended to command in module.
        ext.args2           = Second set of arguments appended to command in module (multi-tool modules).
        ext.args3           = Third set of arguments appended to command in module (multi-tool modules).
        ext.suffix          = File name ext.suffix output files. Not available for nf-core modules
        ext.prefix          = File name prefix for output files.
----------------------------------------------------------------------------------------
*/

process {

    publishDir = [
        path: { "${params.outdir}/${task.process.tokenize(':')[-1].tokenize('_')[0].toLowerCase()}" },
        mode: 'copy',
        saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
    ]

    withName: CUSTOM_DUMPSOFTWAREVERSIONS {
        publishDir = [
            path: { "${params.outdir}/pipeline_info" },
            mode: 'copy',
            pattern: '*_versions.yml'
        ]
    }
}

// PREPARE_GENOME
process {

    withName: 'BWAMEM1_INDEX' {
        publishDir = [
            path: { "${params.outdir}/reference/bwa" },
            enabled: "params.save_reference",
            pattern: "*{amb,ann,bwt,pac,sa}",
            mode: 'copy'
        ]
    }

    withName: 'BWAMEM2_INDEX' {
        publishDir = [
            path: { "${params.outdir}/reference/bwamem2" },
            enabled: "params.save_reference",
            pattern: "*{0123,amb,ann,bwt.2bit.64,bwt.8bit.32,pac}",
            mode: 'copy'
        ]

    }
    withName: 'CREATE_INTERVALS_BED' {
        publishDir = [
            path: { "${params.outdir}/reference/intervals" },
            enabled: "params.save_reference",
            pattern: "*bed",
            mode: 'copy'
        ]
    }

    withName: 'GATK4_CREATESEQUENCEDICTIONARY' {
        publishDir = [
            path: { "${params.outdir}/reference/gatk4" },
            enabled: "params.save_reference",
            pattern: "*dict",
            mode: 'copy'
        ]
    }

    withName: 'MSISENSORPRO_SCAN' {
        publishDir = [
            path: { "${params.outdir}/reference/msi" },
            enabled: "params.save_reference",
            pattern: "*list",
            mode: 'copy'
        ]
    }

    withName: 'SAMTOOLS_FAIDX' {
        publishDir = [
            path: { "${params.outdir}/reference/fai" },
            enabled: "params.save_reference",
            pattern: "*fai",
            mode: 'copy'
        ]
    }

    withName: 'TABIX_BGZIPTABIX' {
        publishDir = [
            path: { "${params.outdir}/reference/target" },
            enabled: "params.save_reference",
            pattern: "*bed.gz",
            mode: 'copy'
        ]
        ext.prefix = {"${meta.id}.bed"}

    }

    withName: 'TABIX_DBSNP' {
        publishDir = [
            path: { "${params.outdir}/reference/dbsnp" },
            enabled: "params.save_reference",
            pattern: "*vcf.gz.tbi",
            mode: 'copy'
        ]
    }

    withName: 'TABIX_GERMLINE_RESOURCE' {
        publishDir = [
            path: { "${params.outdir}/reference/germline_resource" },
            enabled: "params.save_reference",
            pattern: "*vcf.gz.tbi",
            mode: 'copy'
        ]
    }

    withName: 'TABIX_KNOWN_INDELS' {
        publishDir = [
            path: { "${params.outdir}/reference/known_indels" },
            enabled: "params.save_reference",
            pattern: "*vcf.gz.tbi",
            mode: 'copy'
        ]
    }

    withName: 'TABIX_PON' {
        publishDir = [
            path: { "${params.outdir}/reference/pon" },
            enabled: "params.save_reference",
            pattern: "*vcf.gz.tbi",
            mode: 'copy'
        ]
    }
}

// UMI Subworkflow
process{
    withName: 'BAM2FASTQ' {
        ext.args  = '-T RX'
    }

    withName: 'SAMBLASTER' {
        ext.prefix       = {"${meta.id}_unsorted_tagged"}
        ext.args         = '-M --addMateTags'
    }

    withName: 'CALLUMICONSENSUS' {
        ext.args         = '-M 1 -S Coordinate'
        ext.prefix       = {"${meta.id}_umi-consensus"}
    }
}

if(params.umi_read_structure){
    process {
        withName: "NFCORE_SAREK:SAREK:CREATE_UMI_CONSENSUS:BWA.*_MEM" {
            ext.args = '-p -C -M'
            ext.prefix = {"${meta.id}.umi_unsorted"}
            ext.args2 = '-bS'
        }
    }
}

//BAMTOFASTQ
process {
    withName: 'SAMTOOLS_VIEW_MAP_MAP' {
        ext.args = '-b -f1 -F12'
        ext.prefix = {"${meta.id}.map_map"}
    }
    withName: 'SAMTOOLS_VIEW_UNMAP_UNMAP' {
        ext.args = '-b -f12 -F256'
        ext.prefix = {"${meta.id}.unmap_unmap"}
    }
    withName: 'SAMTOOLS_VIEW_UNMAP_MAP' {
        ext.args = '-b -f4 -F264'
        ext.prefix = {"${meta.id}.unmap_map"}
    }
    withName: 'SAMTOOLS_VIEW_MAP_UNMAP' {
        ext.args = '-b -f8 -F260'
        ext.prefix = {"${meta.id}.map_unmap"}
    }
    withName: 'SAMTOOLS_FASTQ_UNMAPPED'{
        ext.args2 = '-N'
        ext.prefix = {"${meta.id}.unmapped"}
    }
    withName: 'SAMTOOLS_FASTQ_MAPPED'{
        ext.args2 = '-N'
        ext.prefix = {"${meta.id}.mapped"}
    }
}

// QC_TRIM
process {
    withName: 'FASTQC' {
        ext.args         = '--quiet'
        publishDir       = [
            path: { "${params.outdir}/reports/fastqc/${meta.id}" }
        ]
    }
    withName: 'TRIMGALORE' {
        ext.args         = '--fastqc'
        publishDir       = [
            path: { "${params.outdir}/trimgalore/${meta.id}" }
        ]
    }
    // withName: 'MULTIQC' {
    //     ext.args         = ''
    // }
}


// MAPPING
process {

    withName: "BWA.*MEM" {
        ext.args         = { meta.status == 1 ? '-K 100000000 -M -B 3' : '-K 100000000 -M' }
        publishDir       = [ enabled: false ]
        ext.prefix       = { params.split_fastq > 1 ?  "${meta.id}".concat('.').concat(reads.get(0).name.findAll(/part_([0-9]+)?/).last()) : "" }
    }

    withName: 'INDEX_MAPPING' {
        publishDir       = [
            path: { "${params.outdir}/preprocessing/${meta.id}/mapped" },
            enabled: true,
            pattern: "*{bam,bai}"
        ]
    }

    withName: "SEQKIT_SPLIT2" {
        ext.args         = { "--by-size ${params.split_fastq}" }
        publishDir = [
            path: { "${params.outdir}/${task.process.tokenize(':')[-1].tokenize('_')[0].toLowerCase()}" },
            mode: 'copy',
            enabled: params.save_split_fastqs,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
}

// Markduplicates Spark NEEDS name-sorted reads or runtime goes through the roof
// However if it's skipped, reads need to be coordinate-sorted
// Spark can be used also for BQSR, therefore check for both
// Only name sort if Spark for Markduplicates + duplicate marking is not skipped
if (('markduplicates' in params.use_gatk_spark) && (!params.skip_markduplicates)) {
    process {
        withName: "BWA.*_MEM" { ext.args2 = '-n' }
    }
}

// MARKDUPLICATES
process {
    withName: 'GATK4_ESTIMATELIBRARYCOMPLEXITY' {
        ext.prefix       = {"${meta.id}.md"}
        publishDir       = [
            path: { "${params.outdir}/preprocessing/${meta.id}/markduplicates" },
            enabled: true,
            pattern: "*{metrics}"
        ]
    }
    withName: 'GATK4_MARKDUPLICATES' {
        ext.args         = '-REMOVE_DUPLICATES false -VALIDATION_STRINGENCY LENIENT'
        ext.prefix       = {"${meta.id}.md"}
        publishDir       = [
            path: { "${params.outdir}/preprocessing/${meta.id}/markduplicates" },
            enabled: false
        ]
    }
    withName: 'GATK4_MARKDUPLICATES_SPARK' {
        ext.args         = '--remove-sequencing-duplicates false -VS LENIENT'
        ext.suffix       = '.md'
        publishDir       = [
            path: { "${params.outdir}/preprocessing/${meta.id}/markduplicates" },
            enabled: true,
            pattern: "*{cram,crai}"
        ]
    }
    withName: 'QUALIMAP_BAMQC' {
        ext.args         = '--paint-chromosome-limits --genome-gc-distr HUMAN -skip-duplicated --skip-dup-mode 0 -outformat HTML'
        ext.suffix       = '.mapped'
        publishDir       = [
            path: { "${params.outdir}/reports/qualimap/${meta.id}" },
            enabled: true
        ]
    }
    withName: 'SAMTOOLS_STATS' {
        publishDir       = [
            path: { "${params.outdir}/reports/samtools_stats/${meta.id}" },
            enabled: true
        ]
    }
    withName: 'SAMTOOLS_BAM_TO_CRAM|SAMTOOLS_BAM_TO_CRAM_SPARK' {
        ext.suffix       = '.md'
        publishDir       = [
            path: { "${params.outdir}/preprocessing/${meta.id}/markduplicates" },
            enabled: true,
            pattern: "*{cram,crai}"
        ]
    }
    withName: 'INDEX_MARKDUPLICATES' {
        publishDir       = [
            path: { "${params.outdir}/preprocessing/${meta.id}/markduplicates" },
            enabled: true,
            pattern: "*{cram,crai}"
        ]
    }
}

// PREPARE_RECALIBRATION
process {
    withName: 'BASERECALIBRATOR|BASERECALIBRATOR_SPARK|GATHERBQSRREPORTS' {
        publishDir       = [
            path: { "${params.outdir}/preprocessing/${meta.id}/recal_table" },
            enabled: true,
            mode: 'copy',
            pattern: "*.table"
        ]
        ext.prefix = {"${meta.id}.recal"}
    }
}

// RECALIBRATE
process {
    withName: 'APPLYBQSR|APPLYBQSR_SPARK' {
        ext.prefix = {"${meta.id}.recal"}
        publishDir       = [ enabled: false ]
    }
    withName: 'SAMTOOLS_MERGE_CRAM' {
        ext.suffix       = '.recal'
        publishDir       = [
            path: { "${params.outdir}/preprocessing/${meta.id}/recalibrated" },
            enabled: true,
            pattern: "*cram"
        ]
    }
    withName: 'QUALIMAP_BAMQC_CRAM' {
        ext.args         = '--paint-chromosome-limits --genome-gc-distr HUMAN -skip-duplicated --skip-dup-mode 0 -outformat HTML'
        ext.suffix       = '.recal'
        publishDir       = [
            path: { "${params.outdir}/reports/qualimap/${meta.id}" },
            enabled: true
        ]
    }
    withName: 'INDEX_RECALIBRATE' {
        ext.suffix       = 'recal'
        publishDir       = [
            path: { "${params.outdir}/preprocessing/${meta.id}/recalibrated" },
            enabled: true,
            pattern: "*{recal.cram,recal.cram.crai}"
        ]
    }
    withName: 'SAMTOOLS_STATS' {
        publishDir       = [
            path: { "${params.outdir}/reports/samtools_stats/${meta.id}" },
            enabled: true
        ]
    }
}

// GERMLINE & TUMOR ONLY Variant_Calling
process{
    withName: 'CONCAT_.*VCF_DEEPVARIANT' {
        publishDir       = [
            path: { "${params.outdir}/variant_calling/${meta.sample}/deepvariant" },
            enabled: true,
        ]
        ext.args         = { params.no_intervals ?  "-n" : "" }
        ext.prefix        = {"${meta.sample}"}
    }

    withName: 'CONCAT_VCF_FREEBAYES' {
        publishDir       = [
            path: { "${params.outdir}/variant_calling/${meta.sample}/freebayes" },
            enabled: true,
        ]
        ext.args         = { params.no_intervals ?  "-n" : "" }
        ext.prefix        = {"${meta.sample}"}

    }
    withName: 'CONCAT_VCF_HAPLOTYPECALLER' {
        publishDir       = [
            path: { "${params.outdir}/variant_calling/${meta.sample}/haplotypecaller" },
            enabled: true,
        ]
        ext.args         = { params.no_intervals ?  "-n" : "" }
        ext.prefix        = {"${meta.sample}.g"}
    }
    withName: 'CONCAT_VCF_MANTA_.*' {
        publishDir       = [
            path: { "${params.outdir}/variant_calling/${meta.sample}/manta" },
            enabled: true,
        ]
        ext.args         = { params.no_intervals ?  "-n" : "" }
        ext.prefix        = {"${meta.sample}"}
    }
    withName: 'CONCAT_VCF_MUTECT2' {
        publishDir       = [
            path: { "${params.outdir}/variant_calling/${meta.sample}/mutect2" },
            enabled: true,
        ]
        ext.args         = { params.no_intervals ?  "-n" : "" }
        ext.prefix        = {"${meta.sample}"}
    }
    withName: 'CONCAT_VCF_STRELKA' {
        publishDir       = [
            path: { "${params.outdir}/variant_calling/${meta.sample}/strelka" },
            enabled: true,
        ]
        ext.args         = { params.no_intervals ?  "-n" : "" }
        ext.prefix        = {"${meta.sample}"}
    }
    withName: 'DEEPVARIANT' {
        ext.args         = { params.wes ?  "--model_type WES" : "--model_type WGS" }
    }
    withName: 'FREEBAYES' {
        publishDir       = [
            path: { "${params.outdir}/variant_calling/${meta.sample}/manta" },
            enabled: params.no_intervals,
        ]
        ext.args         = '--min-alternate-fraction 0.1 --min-mapping-quality 1'
    }
    //withName: 'GATK4_CALCULATECONTAMINATION'{
    //    publishDir        = [ enabled: false ]
    //    ext.args          = ''
    //}
    //withName: 'GATK4_FILTERMUTECTCALLS'{
    //    publishDir        = [ enabled: false ]
    //    ext.args          = ''
    //}
    //withName: 'GATK4_GETPILEUPSUMMARIES'{
    //    publishDir        = [ enabled: false ]
    //    ext.args          = ''
    //}
    withName: 'GATK4_MUTECT2'{
        publishDir       = [
            path: { "${params.outdir}/variant_calling/${meta.sample}/mutect2" },
            enabled: params.no_intervals,
        ]
    }
    //withName: 'GENOMICSDBIMPORT' {
    //
    //}
    withName: 'HAPLOTYPECALLER' {
        ext.args         = '-ERC GVCF'
        publishDir        = [ enabled: false ]
    }
    withName: 'MANTA_GERMLINE|MANTA_TUMORONLY|MANTA_SOMATIC' {
        publishDir       = [
            path: { "${params.outdir}/variant_calling/${meta.sample}/manta" },
            enabled: params.no_intervals,
        ]
        ext.args         = { params.wes ? "--exome" : "" }
    }
    withName: 'STRELKA_GERMLINE|STRELKA_TUMORONLY|STRELKA_SOMATIC|STRELKA_BP' {
        publishDir       = [
            path: { "${params.outdir}/variant_calling/${meta.sample}/strelka" },
            enabled: params.no_intervals,
        ]
        ext.args         = { params.wes ? "--exome" : "" }
    }
    withName : 'TABIX_DEEPVARIANT_VCF|TABIX_DEEPVARIANT_GVCF' {
        publishDir       = [
            path: { "${params.outdir}/variant_calling/${meta.sample}/deepvariant" },
            enabled: true,
        ]
        ext.prefix        = {"${meta.sample}"}
    }
    withName : 'TABIX_FREEBAYES' {
        publishDir       = [
            path: { "${params.outdir}/variant_calling/${meta.sample}/freebayes" },
            enabled: true,
        ]
        ext.prefix        = {"${meta.sample}"}
    }
    withName : 'TABIX_HAPLOTYPECALLER' {
        publishDir       = [
            path: { "${params.outdir}/variant_calling/${meta.sample}/haplotypecaller" },
            enabled: true,
        ]
        ext.prefix        = {"${meta.sample}"}
    }
    //withName: 'TIDDIT_SV' {
    //    publishDir       = [
    //            path: { "${params.outdir}/variant_calling/${meta.sample}/tiddit" },
    //            enabled: true
    //            ]
    //}

}

// TUMOR_VARIANT_CALLING
process{

    withName: 'MERGEMUTECTSTATS' {
        ext.prefix = { "${meta.sample}.vcf.gz" }
    }
    withName: 'GATHERPILEUPSUMMARIES' {
        ext.prefix = { "${meta.sample}.table" }
    }
}

// PAIR_VARIANT_CALLING


// withName: manta_somatic {
//     publishDir       = [
//             path: { "${params.outdir}/variant_calling'
//     publish_files    = ['vcf.gz':'manta', 'vcf.gz.tbi':'manta']
// }
// withName: msisensorpro_msi {
//     publishDir       = [
//             path: { "${params.outdir}/variant_calling'
//     publish_files    = ['list':'msisensorpro']
// }
// withName: strelka_somatic {
//     publishDir       = [
//             path: { "${params.outdir}/variant_calling'
//     publish_files    = ['vcf.gz':'strelka', 'vcf.gz.tbi':'strelka']
// }
// withName: strelka_somatic_bp {
//     publishDir       = [
//             path: { "${params.outdir}/variant_calling'
//     publish_files    = ['vcf.gz':'strelka', 'vcf.gz.tbi':'strelka']
// }
// withName: mutect2_somatic {
//     publishDir       = [
//             path: { "${params.outdir}/variant_calling'
//     publish_files    = ['vcf.gz':'mutect2', 'vcf.gz.tbi':'mutect2']
// }

// ANNOTATE
process {

    withName: 'ENSEMBLVEP' {
        ext.args          = '--everything --filter_common --per_gene --total_length --offline'
        container         = { "nfcore/vep:104.3.${params.genome}" }
        publishDir        = [ enabled: false ]
    }

    withName: 'SNPEFF' {
        ext.args          = '-nodownload -canon -v'
        container         = { "nfcore/snpeff:5.0.${params.genome}" }
        publishDir        = [ enabled: false ]
    }

    withName: 'ANNOTATION_BGZIPTABIX' {
        publishDir       = [
                path: { "${params.outdir}/annotation/${meta.id}" },
                enabled: true,
                pattern: "*{gz,gz.tbi}"
        ]
    }

}

if ((params.tools) && (params.tools.contains('snpeff') || params.tools.contains('merge'))) {
    process {
        withName: 'NFCORE_SAREK:SAREK:ANNOTATE:ANNOTATION_SNPEFF:ANNOTATION_BGZIPTABIX' {
            ext.prefix = {"${meta.id}_snpEff.ann.vcf"}
        }
    }
}

if ((params.tools) && (params.tools.contains('vep'))) {
    process {
        withName: 'NFCORE_SAREK:SAREK:ANNOTATE:ANNOTATION_ENSEMBLVEP:ANNOTATION_BGZIPTABIX' {
            ext.prefix = {"${meta.id}_VEP.ann.vcf"}
        }
    }
}

if ((params.tools) && (params.tools.contains('merge'))) {
    process {
        withName: 'NFCORE_SAREK:SAREK:ANNOTATE:MERGE_ANNOTATE:ANNOTATION_BGZIPTABIX' {
            ext.prefix = {"${meta.id}_snpEff_VEP.ann.vcf"}
        }
    }

}
